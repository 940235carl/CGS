<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #info {
            position: absolute;
            top: 0px;
            width: 100%;
            padding: 10px;
            text-align: center;
            color: #ffff00
        }

        body {
            overflow: hidden;
        }

    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/107/three.min.js"></script>
    <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://raw.githack.com/jyunming-chen/tutsplus/master/js/text2D.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.min.js"></script>

	<script id="myVertexShader" type="x-shader/x-vertex">
        uniform vec3 lightpos;  // world coordinate
            varying vec4 eyepos;
        
        void main() {
                eyepos = modelViewMatrix * vec4 (position, 1.0);
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
    </script>
    <script id="myFragmentShader" type="x-shader/x-fragment">
        varying vec4 eyepos;
        uniform float mytime;
      
       float rand(vec2 co){
          return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
       }
       void main() {
            float grey = rand (vec2(eyepos.x, mytime));
            gl_FragColor = vec4(vec3(grey,grey,grey), 1.0);
        }
    </script>
    <div id = "info"> 
        <button id="play" style="width:15%">change camera</button> 
    </div>
	

	
    <audio id="doorsound" style="display: none;">
        <source src="yisellsound.mp3" type="audio/mp3">
    </audio>
    <audio id="doorsound2" style="display: none">
        <source src="refrigerater1_C.mp3" type="audio/mp3">
    </audio>
    <audio id="Vent" style="display: none">
        <source src="Ventsound.mp3" type="audio/mp3">
    </audio>
    <audio id="lightsound" loop style="display: none">
        <source src="lightsound2.mp3" type="audio/mp3">
    </audio>
    <audio id="lightsound2" loop style="display: none">
        <source src="lightsound2.mp3" type="audio/mp3">
    </audio>
    <audio id="lightsound3" loop style="display: none">
        <source src="lightsound2.mp3" type="audio/mp3">
    </audio>
    <audio id="change" style="display: none">
        <source src="changesound.mp3" type="audio/mp3">
    </audio>
    <audio id="walk"  stytle="display: none">
        <source src="walking_on_a_floor.mp3" type="audio/mp3">
    </audio>
    <audio id="windowwalk"  stytle="display: none">
        <source src="windowsound.mp3" type="audio/mp3">
    </audio>
    <audio id="exitsound"  stytle="display: none">
        <source src="exitsound.mp3" type="audio/mp3">
    </audio>
    <audio id="Ennard"  stytle="display: none">
        <source src="Ennard BOSS.mp3" type="audio/mp3">
    </audio>
    
    <script>
        var camera, scene, renderer, cameraHUD;
        var leftdoor,rightdoor,windowdoor;
        var wallheight = 60 ,windowsize = 40;
        var lightstate1 = 0, lightstate2 = 0, lightstate3 = 0; 
        var light1, light2, light3;
        var rightwallstate = 1, leftwallstate = 1, windowdoorstate = 1;
        var mouse = new THREE.Vector2();
        var raycaster = new THREE.Raycaster();
        var rightlightpickables = [] , leftlightpickables = [] , rightdoorpickables = [] , leftdoorpickables = [], windowdoorpickables = [], windowlightpickables = [], camerapickables = [];
        var rotationy = 0 , viewpoint = 1;
        var Time, usage = 1 ,power = 1000;
        var roomlight;
        var quickswitch = 0 , switchflag = 0;
        var test = new THREE.Vector3(0,0,0);
        var movingstep=1, block=1,mov=0, rdoor=false,ldoor=false,movcor=0,wdoor=false; // ghost moving variable
        var tablet, tabletbody, fliptheta = 0,  pickup = 0;


		var controls, stats, clock, ghost, gui, t = 0, t2 = 0, gControl, steps, keys = [], backkeys = [] ,intkey = [], backintkey = [], move;//é¬¼
		var T = 0.7, T2= 0.7,ready = 0; 
		var clock = new THREE.Clock();
		var ts = clock.getElapsedTime(), ts2 = clock.getElapsedTime();
        var thebox,sound;//soundbox
		var on=0;
        var meshMaterial;
		
		
		var pose3={
				
				bodyRotate: 0.1317,
                bodyHeight: 0.001,
                bodyRotateY: 1.1191,
				rightHandX: -0.7778,
				rightHand2X: 0.001,
                rightHandZ: -0.1492,
				rightHand2Z: 0.001,
                leftHandX: -0.7778,
				leftHand2X: 0.001,
                leftHandZ: 0.1492,
				leftHand2Z: 0.001,
                rightLegX: 0.001,
				rightLeg2X: 0.001,
                rightLegZ: 0.001,
				rightLeg2Z: 0.001,
                leftLegX: 0.001,
				leftLeg2X: 0.001,
                leftLegZ: 0.001,
				leftLeg2Z: 0.001

		}
		
		var pose4={
				
				bodyRotate: 0.2338,
                bodyHeight: 0.001,
                bodyRotateY: 1.1191,
				rightHandX: -0.7778,
				rightHand2X: 0.001,
                rightHandZ: -0.2833,
				rightHand2Z: 0.001,
                leftHandX: -0.7778,
				leftHand2X: 0.001,
                leftHandZ: 0.2833,
				leftHand2Z: 0.001,
                rightLegX: 0.001,
				rightLeg2X: 0.001,
                rightLegZ: 0.001,
				rightLeg2Z: 0.001,
                leftLegX: 0.001,
				leftLeg2X: 0.001,
                leftLegZ: 0.001,
				leftLeg2Z: 0.001

		}
		
		var pose5={
				
				bodyRotate: 0.2879,
                bodyHeight: 0.001,
                bodyRotateY: 1.1191,
				rightHandX: -0.7778,
				rightHand2X: -0.5834,
                rightHandZ: -0.5852,
				rightHand2Z: 0.001,
                leftHandX: -0.7778,
				leftHand2X: -0.5834,
                leftHandZ: 0.5852,
				leftHand2Z: 0.001,
                rightLegX: 0.001,
				rightLeg2X: 0.001,
                rightLegZ: 0.001,
				rightLeg2Z: 0.001,
                leftLegX: 0.001,
				leftLeg2X: 0.001,
                leftLegZ: 0.001,
				leftLeg2Z: 0.001
		
		}
		
		var pose6={
				
				bodyRotate: 0.2879,
                bodyHeight: 0.001,
                bodyRotateY: 1.1191,
				rightHandX: -1.1864,
				rightHand2X: -0.5834,
                rightHandZ: -0.5852,
				rightHand2Z: 0.001,
                leftHandX: -1.1864,
				leftHand2X: -0.5834,
                leftHandZ: 0.5852,
				leftHand2Z: 0.001,
                rightLegX: 0.001,
				rightLeg2X: 0.001,
                rightLegZ: 0.001,
				rightLeg2Z: 0.001,
                leftLegX: 0.001,
				leftLeg2X: 0.001,
                leftLegZ: 0.001,
				leftLeg2Z: 0.001

		}
	
		
		var backpose3={
				
				bodyRotate: 0.1317,
                bodyHeight: 0.001,
                bodyRotateY: 1.1191,
				rightHandX: -0.7778,
				rightHand2X: 0.001,
                rightHandZ: -0.1492,
				rightHand2Z: 0.001,
                leftHandX: -0.7778,
				leftHand2X: 0.001,
                leftHandZ: 0.1492,
				leftHand2Z: 0.001,
                rightLegX: 0.001,
				rightLeg2X: 0.001,
                rightLegZ: 0.001,
				rightLeg2Z: 0.001,
                leftLegX: 0.001,
				leftLeg2X: 0.001,
                leftLegZ: 0.001,
				leftLeg2Z: 0.001
		
		}
		
		var backpose4={
				
				bodyRotate: 0.1317,
                bodyHeight: 0.001,
                bodyRotateY: 1.1191,
				rightHandX: -0.7778,
				rightHand2X: 0.001,
                rightHandZ: -0.2833,
				rightHand2Z: 0.001,
                leftHandX: -0.7778,
				leftHand2X: 0.001,
                leftHandZ: 0.2833,
				leftHand2Z: 0.001,
                rightLegX: 0.001,
				rightLeg2X: 0.001,
                rightLegZ: 0.001,
				rightLeg2Z: 0.001,
                leftLegX: 0.001,
				leftLeg2X: 0.001,
                leftLegZ: 0.001,
				leftLeg2Z: 0.001
		
		}
		
		var backpose5={
				
				bodyRotate: 0.1317,
                bodyHeight: 0.001,
                bodyRotateY: 1.1191,
				rightHandX: -0.7778,
				rightHand2X: -0.5834,
                rightHandZ: -0.5852,
				rightHand2Z: 0.001,
                leftHandX: -0.7778,
				leftHand2X: -0.5834,
                leftHandZ: 0.5852,
				leftHand2Z: 0.001,
                rightLegX: 0.001,
				rightLeg2X: 0.001,
                rightLegZ: 0.001,
				rightLeg2Z: 0.001,
                leftLegX: 0.001,
				leftLeg2X: 0.001,
                leftLegZ: 0.001,
				leftLeg2Z: 0.001
		}
		
		var backpose6={
				
				bodyRotate: 0.1317,
                bodyHeight: 0.001,
                bodyRotateY: 1.1191,
				rightHandX: -1.1864,
				rightHand2X: -0.5834,
                rightHandZ: -0.5852,
				rightHand2Z: 0.001,
                leftHandX: -1.1864,
				leftHand2X: -0.5834,
                leftHandZ: 0.5852,
				leftHand2Z: 0.001,
                rightLegX: 0.001,
				rightLeg2X: 0.001,
                rightLegZ: 0.001,
				rightLeg2Z: 0.001,
                leftLegX: 0.001,
				leftLeg2X: 0.001,
                leftLegZ: 0.001,
				leftLeg2Z: 0.001
		
		}
		
		
		
		var keys = [
			//[0.45, pose0],
			//[0.65, pose1],
			//[0.0, pose2],
			[0.35, pose3],
			[0.45, pose4],
			[0.65, pose5],
			[0.85, pose6],
			[1, pose6]
		];
		
		var backkeys = [
			//[0.45, pose0],
			//[0.65, pose1],
			//[0.0, pose2],
			[0.35, pose3],
			[0.45, pose4],
			[0.65, pose5],
			[0.85, pose6],
			[1, pose6]
		];
	
			
        //change camera
        $('#play').click ( function() {
        if(viewpoint == 0){
            changesound.pause();
            changesound.play();
            camera.position.x = 0;
            camera.position.z = 0;
            camera.position.y = 40;
            camera.lookAt(0,40,-100);
            viewpoint = 1;
            quickswitch = 0;
        }
        else if(viewpoint == 1){
            changesound.pause();
            changesound.play();    
            camera.position.x = 120;
            camera.position.z = 100;
            camera.position.y = 80;
            camera.lookAt(140,10,-50);
            viewpoint = 2;
            quickswitch = 0;
        }
        else if(viewpoint == 2){
            changesound.pause();
            changesound.play();
            camera.position.x = -120;
            camera.position.z = 100;
            camera.position.y = 80;
            camera.lookAt(-140,10,-50);
            viewpoint = 0;
            quickswitch = 0;
        }
        });
     
        class Ghost{
          constructor(gg) {
                this.ghost = new THREE.Object3D();
                
				this.body = new THREE.Object3D();
                this.body.position.set(0,35,0);
                this.body.add(new THREE.Mesh(new THREE.CylinderGeometry(10, 10, 30, 10),gg));

                this.head = new THREE.Mesh(new THREE.SphereGeometry(15, 20, 15, 15, 22, 25, 22),gg);
                this.head.position.set(0,15,0);

                this.rightLeg = new THREE.Object3D();
                this.rightLeg.position.set(-4.5,-16,0);

                let rightLegMesh = new THREE.Mesh(new THREE.BoxGeometry(6,14,7),gg);
                rightLegMesh.position.set(0,-5.0,0);
                this.rightLeg.add(rightLegMesh);

                this.time=0;
                this.ghostin=0;
			////////////////////////////////////////////////////
				this.rightLeg2 = new THREE.Object3D();
                this.rightLeg2.position.set(0,-10.0,0);

                let rightLegMesh2 = new THREE.Mesh(new THREE.BoxGeometry(6,13,7),gg);
                rightLegMesh2.position.set(0,-5.0,0);
                this.rightLeg2.add(rightLegMesh2);




                this.leftLeg = new THREE.Object3D();
                this.leftLeg.position.set(4.5,-16,0);

                let leftLegMesh = new THREE.Mesh(new THREE.BoxGeometry(6,14,7),gg);
                leftLegMesh.position.set(0,-5.0,0);
                this.leftLeg.add(leftLegMesh);
			/////////////////////////////////////////////////////
                this.leftLeg2 = new THREE.Object3D();
                this.leftLeg2.position.set(0,-10.0,0);

                let leftLegMesh2 = new THREE.Mesh(new THREE.BoxGeometry(6,13,7),gg);
                leftLegMesh2.position.set(0,-5.0,0);
                this.leftLeg2.add(leftLegMesh2);




			    this.leftHand = new THREE.Object3D();
                this.leftHand.position.set(12,5,0);

                let leftHandMesh = new THREE.Mesh(new THREE.BoxGeometry(5,13,7),gg);
                //leftHandMesh.position.set(0,0,0);
                this.leftHand.add(leftHandMesh);
			/////////////////////////////////////////////////////
				this.leftHand2 = new THREE.Object3D();
                this.leftHand2.position.set(0,-6.5,0);

                let leftHandMesh2 = new THREE.Mesh(new THREE.BoxGeometry(5,13,7),gg);
                leftHandMesh2.position.set(0,-6.5,0);
                this.leftHand2.add(leftHandMesh2);
				
			
                
				
				
				this.rightHand = new THREE.Object3D();
                this.rightHand.position.set(-12,5,0);

                let rightHandMesh = new THREE.Mesh(new THREE.BoxGeometry(5,13,7),gg);
                //rightHandMesh.position.set(0,0,0);
                this.rightHand.add(rightHandMesh);
				//////////////////////////////////////////////////
				this.rightHand2 = new THREE.Object3D();
                this.rightHand2.position.set(0,-6.5,0);

                let rightHandMesh2 = new THREE.Mesh(new THREE.BoxGeometry(5,13,7),gg);
                rightHandMesh2.position.set(0,-6.5,0);
                this.rightHand2.add(rightHandMesh2);

                this.body.add(this.head, this.rightLeg,this.rightLeg2, this.leftLeg,this.leftLeg2, this.leftHand,this.leftHand2, this.rightHand,this.rightHand2);
                this.leftHand.add(this.leftHand2);
				this.rightHand.add(this.rightHand2);
				this.leftLeg.add(this.leftLeg2);
				this.rightLeg.add(this.rightLeg2);
				this.ghost.add(this.body);


                scene.add(this.ghost);
            }
			
		}
		
		
		
        init();
        animate();
        
        function init() {
            
			scene = new THREE.Scene();
            clock = new THREE.Clock();
            stats = new Stats();
            stats.domElement.style.position = 'absolute';
            stats.domElement.style.top = '0px';
            stats.domElement.style.zIndex = 100;
            document.body.appendChild(stats.domElement);

            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x888888);
            document.body.appendChild(renderer.domElement);

            camera = new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,1,5000);
            camera.position.set(0,150,250);


            //controls = new THREE.OrbitControls(camera, renderer.domElement);
            //controls.enableKeys = false;

            var mesh = new THREE.MeshPhongMaterial({color:'red'}); 

            ghost = new Ghost(mesh);
            
			ghost.ghost.rotation.order = 'ZXY';
			
            ghost.ghost.position.set(-145,0,-45);
            buildMove = function(){
                this.bodyRotate = 0.001;
                this.bodyHeight = 0.001;
                this.bodyRotateY= 0.001 ;
                
				this.rightHandX = 0.001;
                this.rightHandZ = 0.001;
				//////////////////////////
				this.rightHand2X = 0.001;
                this.rightHand2Z = 0.001;
                
				this.leftHandX = 0.001;
                this.leftHandZ = 0.001;
                //////////////////////////
				this.leftHand2X = 0.001;
                this.leftHand2Z = 0.001;
				
				this.rightLegX = 0.001;
                this.rightLegZ = 0.001;
				//////////////////////////
				this.rightLeg2X = 0.001;
                this.rightLeg2Z = 0.001;
                
				this.leftLegX = 0.001;
                this.leftLegZ = 0.001;
				//////////////////////////
				this.leftLeg2X = 0.001;
                this.leftLeg2Z = 0.001;
            };
			
			
            
            gControl = new buildMove();
            move = new buildMove();

            gui = new dat.GUI({load: loadJSON(), preset: 'Default'});
            gui.remember(gControl);
            gui.add(gControl,'bodyRotate',-Math.PI / 2,Math.PI / 2);
            gui.add(gControl,'bodyHeight',0.0,25.0);
            gui.add(gControl,'bodyRotateY',-Math.PI / 2,Math.PI / 2);
            
			
			gui.add(gControl,'rightHandX',-Math.PI * 2 / 3,Math.PI * 2 / 3);
            gui.add(gControl,'rightHandZ',-Math.PI * 2 / 3,1);
			///////////////////////////////////////////////////////////
			gui.add(gControl,'rightHand2X',-Math.PI * 2 / 3,Math.PI * 2 / 3);
            gui.add(gControl,'rightHand2Z',-Math.PI * 2 / 3,1);
            
			gui.add(gControl,'leftHandX',-Math.PI * 2 / 3,Math.PI * 2 / 3);
            gui.add(gControl,'leftHandZ',0,Math.PI * 2 / 3);
			///////////////////////////////////////////////////////////
			gui.add(gControl,'leftHand2X',-Math.PI / 2,Math.PI / 2);
            gui.add(gControl,'leftHand2Z',-Math.PI / 4,Math.PI / 4);
            
			gui.add(gControl,'rightLegX',-Math.PI * 2 / 3,Math.PI * 2 / 3);
            gui.add(gControl,'rightLegZ',-Math.PI * 2 / 3,1);
			///////////////////////////////////////////////////////////
			gui.add(gControl,'rightLeg2X',-Math.PI * 2 / 3,Math.PI * 2 / 3);
            gui.add(gControl,'rightLeg2Z',-Math.PI * 2 / 3,1);
            
			gui.add(gControl,'leftLegX',-Math.PI * 2 / 3,Math.PI * 2 / 3);
            gui.add(gControl,'leftLegZ',0,Math.PI * 2 / 3);
			///////////////////////////////////////////////////////////
			gui.add(gControl,'leftLeg2X',-Math.PI / 2,Math.PI / 2);
            gui.add(gControl,'leftLeg2Z',-Math.PI / 4,Math.PI / 4);

            let step = loadJSON();
            steps = [step.remembered.Step0["0"],step.remembered.Step1["0"],step.remembered.Step2["0"],
                step.remembered.Step3["0"],step.remembered.Step4["0"],step.remembered.Step5["0"],step.remembered.Step6["0"]];

        ///////////////////////////////////////////////////////////////////  Get sound Resource
		
		doorsound = document.getElementById("doorsound");
        doorsound2 = document.getElementById("doorsound2");
        ventsound = document.getElementById("Vent");
        leftlightsound = document.getElementById("lightsound");
        leftlightsound.volume = 0.2;
        rightlightsound = document.getElementById("lightsound2");
        rightlightsound.volume = 0.2;
        windowlightsound = document.getElementById("lightsound3");
        windowlightsound.volume = 0.2;
        walkssound = document.getElementById("walk");
        windowwalksound = document.getElementById("windowwalk");
        exitsound = document.getElementById("exitsound");
        changesound = document.getElementById("change");
        /////////////////////////////////////// èæ¯
        surroundings = document.getElementById("Ennard");
        surroundings.volume = 0.9;
        
        ///////////////////////////////////////////////////////////////////////////////////////////
        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.z = 10;
        camera.position.y = 40;
        
        cameraHUD = new THREE.OrthographicCamera(-10, 10, 10, -10, -10, 1600);
        cameraHUD.position.z = 1580;
        
        sceneHUD = new THREE.Scene();
        //camera.lookAt(0,200,-100);
        //////////////////OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOrbit here////////////////////////////////////
        //let controls = new THREE.OrbitControls(camera, renderer.domElement);

        ////////////////////////////////////////////////////////////////
        //var gridXZ = new THREE.GridHelper(200, 20, 'red', 'white');
        //scene.add(gridXZ);
        
        
        ///////////////////////////////////////////////////////  floor
        let loader = new THREE.TextureLoader();
        loader.crossOrigin = '';
        texture = loader.load('https://i.imgur.com/DrvlmNW.jpg');
        alpha = loader.load('https://i.imgur.com/pYpcBHY.png');
        var texMat = new THREE.MeshPhongMaterial({
            map: texture,
            //alphaMap: alpha,
            transparent: true,
            side: THREE.DoubleSide
        });
        
        
        var geometry = new THREE.PlaneGeometry( 205, 205, 32 );
            var plane = new THREE.Mesh( geometry, texMat );
            scene.add( plane );
        plane.rotation.x = Math.PI/2;

        /////////////////////////////////////////   light
        roomlight = new THREE.PointLight(0xffffff, 1 , 140);
        roomlight.position.set(0, 50, 0);
        scene.add(roomlight);
        /////right light
        light1 = new THREE.PointLight(0xffffff, 1 , 1);
        light1.position.set(150, 50, -20);
        scene.add(light1);
        
        light11 = new THREE.PointLight(0xffffff, 1 , 1);
        light11.position.set(150, 50, -140);
        scene.add(light11);
        /////left light
        light2 = new THREE.PointLight(0xffffff, 1 , 1);
        light2.position.set(-150, 50, -20);
        scene.add(light2);
        
        light21 = new THREE.PointLight(0xffffff, 1 , 1);
        light21.position.set(-150, 50, -140);
        scene.add(light21);

        /////window light
        light3 = new THREE.PointLight(0xffffff, 1 , 1);
        light3.position.set(0, wallheight + windowsize/2 + windowsize/2 - 6 , 100 + 25/2 + 5);
        scene.add(light3);
        
        /////////////////////////////////////////////////////////////////
        /*var testlight = new THREE.PointLight(0xffffff, 1 , 2000);
        testlight.position.set(0, 50, 200);
        scene.add(testlight);*/
        
        
        var geometry = new THREE.BoxGeometry(200, wallheight ,5);
            var material = new THREE.MeshPhongMaterial( {color: 0x5c4332, side: THREE.DoubleSide} );
            var initwall1 = new THREE.Mesh( geometry, material );
            scene.add( initwall1 );
        initwall1.position.set(0,wallheight/2,100);
            var initwall2 = new THREE.Mesh( geometry, material );
            scene.add( initwall2 );
        initwall2.position.set(0,wallheight/2,-100);

        // set door size
        var doorsize = 30;
        makewall(doorsize,wallheight);
        openrightdoor();
        openleftdoor();
        
        var tablesize = 5;
        // set table size     two constant to set position
        maketable(tablesize , 0, -40);
        
        ///var windowsize = 40;
        makewindow(wallheight, windowsize);
        openwindowdoor();
        
        makebuttoms(wallheight,doorsize);
        
        ////view point
        document.addEventListener('mousemove', onDocumentMouseMove, false);
            //set camera to look front
        camera.lookAt(0,40,-100);
        

        ///////////////////////////OOOOOOOOOOOOOOOOOOOOOO IT'S HUD

        makehud();
        

        /////outside
        makeoutside();
        
	/////camera change
  	makecamerabuttom();


  	////new add////////////
  	maketablet();

        Time = new THREE.Clock();
        
        
        renderer.autoClear = false;
        
        document.addEventListener("keydown", onDocumentKeyDown, false);

        ////////////////////// create listener
        var listener = new THREE.AudioListener();
        listener.crossOrigin = "anonymous";
        camera.add(listener);


        ///////////////////// set positionalaudio

        sound = new THREE.PositionalAudio( listener );
        sound.setMediaElementSource( walkssound );
        sound.setRefDistance( 50 );
        sound.panner.setOrientation(1,0,0);
        var envir=360;
        sound.setDirectionalCone( envir, 0, 0.1 );

        var box = new THREE.BoxGeometry(2,1,5);
        thebox = new THREE.Mesh(box,new THREE.MeshNormalMaterial());
        thebox.add(sound);
        scene.add(thebox);
        ghost.body.add(thebox);
        thebox.position.set(20,10,0);


        //////////////////////////////////////// White noise
        meshMaterial = new THREE.ShaderMaterial({
        uniforms: {
            lightpos: {type: 'v3', value: new THREE.Vector3()},
            mytime: {type:'f', value: 1.0}
        },
        vertexShader: document.getElementById('myVertexShader').textContent,
        fragmentShader: document.getElementById('myFragmentShader').textContent
        });

        /////////////////////////////// surrounding sound
        surroundings.play();


        }

        var geometry = new THREE.PlaneGeometry (100,100);
        var mesher = new THREE.Mesh(geometry, meshMaterial);
        mesher.rotation.y=Math.PI/5.4;
        mesher.rotation.x=Math.PI/4.3;
        //sceneHUD.add(mesher);
        /////////////////////////////////  ghost moving function

        function moves(){
            if(movingstep==2&&movcor==0) setTimeout(moves,1000);
            var test = Math.floor(Math.random()*100+1);
            if(ghost.mov==1){
                if(test>0&&test<10){
                    walksound();
                    ghost.ghost.position.set(-145,0,-45);
                    movcor=1;
					
                    ghost.ghost.rotation.x = gControl.bodyRotate = 0.336;
                    ghost.ghost.position.y = gControl.bodyHeight = 1;
                    ghost.ghost.rotation.y = gControl.bodyRotateY = 2;

                    ghost.leftLeg.rotation.x = gControl.leftLegX = 0.001;
                    ghost.leftLeg.rotation.z = gControl.leftLegZ = 0.001;
                    ///////////////////////////////////////////////
                    ghost.leftLeg2.rotation.x = gControl.leftLeg2X = 0.2338;
                    ghost.leftLeg2.rotation.z = gControl.leftLeg2Z = 0.001;
                
                    ghost.rightLeg.rotation.x = gControl.rightLegX = -0.5962;
                    ghost.rightLeg.rotation.z = gControl.rightLegZ = -0.3169;
                    ///////////////////////////////////////////////
                    ghost.rightLeg2.rotation.x = gControl.rightLeg2X = 0.7658;
                    ghost.rightLeg2.rotation.z = gControl.rightLeg2Z = -0.0486;
                
                    ghost.leftHand.rotation.x = gControl.leftHandX = -0.1876;
                    ghost.leftHand.rotation.z = gControl.leftHandZ = 0.8172;
                    ///////////////////////////////////////////////
                    ghost.leftHand2.rotation.x = gControl.leftHand2X = 0.001;
                    ghost.leftHand2.rotation.z = gControl.leftHand2Z = 0.001;
                
                    ghost.rightHand.rotation.x = gControl.rightHandX = -0.2784;
                    ghost.rightHand.rotation.z = gControl.rightHandZ = -0.9206;
                    ////////////////////////////////////////////////
                    ghost.rightHand2.rotation.x = gControl.rightHand2X = -0.687;
                    ghost.rightHand2.rotation.z = gControl.rightHand2Z = 0.001;
                    setTimeout(walksound,1000);
                    setTimeout(closecheck,0);
                }
                else console.log('fail');
            }
            else if(ghost.mov==2){
                if(test>0&&test<10){
                    walksound();
                    ghost.ghost.position.set(145,0,-45);
                    movcor=1;
					
                    ghost.ghost.rotation.x = gControl.bodyRotate = 0.37;
                    ghost.ghost.position.y = gControl.bodyHeight = 0;
                    ghost.ghost.rotation.y = gControl.bodyRotateY = -2;

                    ghost.leftLeg.rotation.x = gControl.leftLegX = -0.687;
                    ghost.leftLeg.rotation.z = gControl.leftLegZ = 0.4086;
                    ///////////////////////////////////////////////
                    ghost.leftLeg2.rotation.x = gControl.leftLeg2X = 0.7204;
                    ghost.leftLeg2.rotation.z = gControl.leftLeg2Z = 0;
                
                    ghost.rightLeg.rotation.x = gControl.rightLegX = -0.7324;
                    ghost.rightLeg.rotation.z = gControl.rightLegZ = -0.0486;
                    ///////////////////////////////////////////////
                    ghost.rightLeg2.rotation.x = gControl.rightLeg2X = 0.7658;
                    ghost.rightLeg2.rotation.z = gControl.rightLeg2Z = 0.001;
                
                    ghost.leftHand.rotation.x = gControl.leftHandX = -0.1423;
                    ghost.leftHand.rotation.z = gControl.leftHandZ = 0.6356;
                    ///////////////////////////////////////////////
                    ghost.leftHand2.rotation.x = gControl.leftHand2X = -1.1864;
                    ghost.leftHand2.rotation.z = gControl.leftHand2Z = 0;
                
                    ghost.rightHand.rotation.x = gControl.rightHandX = -0.3692;
                    ghost.rightHand.rotation.z = gControl.rightHandZ = -0.7864;
                    ////////////////////////////////////////////////
                    ghost.rightHand2.rotation.x = gControl.rightHand2X = -0.8558;
                    ghost.rightHand2.rotation.z = gControl.rightHand2Z = -0.0821;
                    
					setTimeout(walksound,1000);
                    setTimeout(closecheck,0);
				}
                else console.log('fail');               
            }
            else{
                if(test>0&&test<10){
                    windowwalk();
                    
					ghost.body.position.set(0,70,0);
					ghost.ghost.position.set(0, 0, 120);
					movcor=1;
					
					ghost.ghost.rotation.x = gControl.bodyRotate = -1.0941;
                    ghost.ghost.position.y = gControl.bodyHeight = 7.9416;
                    ghost.ghost.rotation.y = gControl.bodyRotateY = 0;

                    ghost.leftLeg.rotation.x = gControl.leftLegX = -0.5054;
                    ghost.leftLeg.rotation.z = gControl.leftLegZ = 0.001;
                    ///////////////////////////////////////////////
                    ghost.leftLeg2.rotation.x = gControl.leftLeg2X = 0.001;
                    ghost.leftLeg2.rotation.z = gControl.leftLeg2Z = 0.001;
                
                    ghost.rightLeg.rotation.x = gControl.rightLegX = -0.5054;
                    ghost.rightLeg.rotation.z = gControl.rightLegZ = 0.001;
                    ///////////////////////////////////////////////
                    ghost.rightLeg2.rotation.x = gControl.rightLeg2X = 0.001;
                    ghost.rightLeg2.rotation.z = gControl.rightLeg2Z = 0.001;
                
                    ghost.leftHand.rotation.x = gControl.leftHandX = 2.0944;
                    ghost.leftHand.rotation.z = gControl.leftHandZ = 1.1123;
                    ///////////////////////////////////////////////
                    ghost.leftHand2.rotation.x = gControl.leftHand2X = 0.5743;
                    ghost.leftHand2.rotation.z = gControl.leftHand2Z = 0.001;
                
                    ghost.rightHand.rotation.x = gControl.rightHandX = 1.2652;
                    ghost.rightHand.rotation.z = gControl.rightHandZ = -1.0212;
                    ////////////////////////////////////////////////
                    ghost.rightHand2.rotation.x = gControl.rightHand2X = -0.006;
                    ghost.rightHand2.rotation.z = gControl.rightHand2Z = 0.4545;

					
					setTimeout(windowwalkstop,2000);
                    setTimeout(closecheck,0);
                }
                else console.log('fail');
            }
        }

        /////////////////////////////// walksound play()
        function walksound(){
            walkssound.play();
        }

        function windowwalk(){
            windowwalksound.play();
        }
        function windowwalkstop(){
            windowwalksound.pause();
        }
        function ghostexit(){
            exitsound.play();
        }       
        function ghostexitstop(){
            exitsound.pause();
        }

        function closecheck(){
            if(ghost.time==5){
                movingstep=1;
                block=1;
                ghost.time=0;
                ghost.ghostin=0;
                if(ghost.mov==3){
                    windowwalk();
                    setTimeout(windowwalkstop,2000);
                }
                else{
                    ghostexit();
                    setTimeout(ghostexitstop,2000);
                }
                clearTimeout(closecheck);
            }   
            else if(ghost.ghostin>10){
                on=1;
				movingstep=3;
                block=1;
                ghost.time=0;
                var checkpoint = new THREE.Vector3(0,0,0);
                camera.getWorldDirection(checkpoint);
                console.log(checkpoint.x,checkpoint.z);
                if(ghost.mov==1 &&checkpoint.x<-0.7599295200492424 &&checkpoint.z>-0.6500054804059181|| ghost.mov==2&&checkpoint.x>0.7447445969389143 &&checkpoint.z>-0.6673495975351258||ghost.mov==3&&checkpoint.x==0&&checkpoint.z==-1.0){
                jumpscare();
                clearTimeout(closecheck);
                }
                else setTimeout(closecheck,0);
            }
            else{
                if(ghost.mov==1&&ldoor||ghost.mov==2&&rdoor||ghost.mov==3&&wdoor){
                    ghost.time+=1;
                    setTimeout(closecheck,1000);
                }
                else{
                    ghost.ghostin+=1;
                    setTimeout(closecheck,1000);
                }
            }
            console.log(ghost.ghostin);

        }

        function jumpscare(){
            
			var pos = camera.localToWorld(new THREE.Vector4(0,0,-40,0));
            ghost.ghost.position.set(pos.x,pos.y,pos.z);	
			ready=1;
		}

        function animate() {
		
			stats.update();
			
			
		/////////////////////////////////////////////////////////////////////// set origin position
		if(movingstep==1&&block==1){
            if(ghost.body.position.y==70) {ghost.body.position.y=35;}
            //var ran = Math.floor(Math.random()*3+1);
            var ran=3;
            if(ran == 1){
                ghost.ghost.position.set(-145,0,-125);
                ghost.mov=1;
				
				ghost.ghost.rotation.x = gControl.bodyRotate = 0.37;
                ghost.ghost.position.y = gControl.bodyHeight = 1.8967;
                ghost.ghost.rotation.y = gControl.bodyRotateY = 0;

				ghost.leftLeg.rotation.x = gControl.leftLegX = -0.0968;
                ghost.leftLeg.rotation.z = gControl.leftLegZ = 0.0227;
				///////////////////////////////////////////////
				ghost.leftLeg2.rotation.x = gControl.leftLeg2X = 0.7446;
                ghost.leftLeg2.rotation.z = gControl.leftLeg2Z = 0.001;
               
			    ghost.rightLeg.rotation.x = gControl.rightLegX = -0.8232;
                ghost.rightLeg.rotation.z = gControl.rightLegZ = -0.2498;
				///////////////////////////////////////////////
				ghost.rightLeg2.rotation.x = gControl.rightLeg2X = 0.7204;
                ghost.rightLeg2.rotation.z = gControl.rightLeg2Z = 0.052;
               
			    ghost.leftHand.rotation.x = gControl.leftHandX = -0.3692;
                ghost.leftHand.rotation.z = gControl.leftHandZ = 1.0442;
				///////////////////////////////////////////////
				ghost.leftHand2.rotation.x = gControl.leftHand2X = -1.1622;
                ghost.leftHand2.rotation.z = gControl.leftHand2Z = 0.0658;
               
			    ghost.rightHand.rotation.x = gControl.rightHandX = -0.5054;
                ghost.rightHand.rotation.z = gControl.rightHandZ = -1.0883;
				////////////////////////////////////////////////
				ghost.rightHand2.rotation.x = gControl.rightHand2X = -1.0048;
                ghost.rightHand2.rotation.z = gControl.rightHand2Z = 0.052;
            
			}
            else if(ran == 2){
                
				ghost.ghost.position.set(145,0,-125);
                ghost.mov=2;
				
				
				ghost.ghost.rotation.x = gControl.bodyRotate = 0.37;
                ghost.ghost.position.y = gControl.bodyHeight = 1.8967;
                ghost.ghost.rotation.y = gControl.bodyRotateY = 0;

				ghost.leftLeg.rotation.x = gControl.leftLegX = -0.1422;
                ghost.leftLeg.rotation.z = gControl.leftLegZ = 0.0227;
				///////////////////////////////////////////////
				ghost.leftLeg2.rotation.x = gControl.leftLeg2X = 0.4722;
                ghost.leftLeg2.rotation.z = gControl.leftLeg2Z = 0.001;
               
			    ghost.rightLeg.rotation.x = gControl.rightLegX = -0.914;
                ghost.rightLeg.rotation.z = gControl.rightLegZ = -0.1157;
				///////////////////////////////////////////////
				ghost.rightLeg2.rotation.x = gControl.rightLeg2X = 0.5388;
                ghost.rightLeg2.rotation.z = gControl.rightLeg2Z = 0.0185;
               
			    ghost.leftHand.rotation.x = gControl.leftHandX = -0.3692;
                ghost.leftHand.rotation.z = gControl.leftHandZ = 1.0442;
				///////////////////////////////////////////////
				ghost.leftHand2.rotation.x = gControl.leftHand2X = -1.1622;
                ghost.leftHand2.rotation.z = gControl.leftHand2Z = 0.0658;
               
			    ghost.rightHand.rotation.x = gControl.rightHandX = -0.5054;
                ghost.rightHand.rotation.z = gControl.rightHandZ = -1.0883;
				////////////////////////////////////////////////
				ghost.rightHand2.rotation.x = gControl.rightHand2X = -1.0048;
                ghost.rightHand2.rotation.z = gControl.rightHand2Z = 0.052;
            
			}
			else{
                ghost.mov=3;
				ghost.body.position.set(0,70,0);
                ghost.ghost.position.set(0,0,160);
				   
			}
            movcor=0;
            movingstep=2;
            block=0;
            mov=0;
            ready=0;
        }
        //keyframe(clock.getElapsedTime());
		requestAnimationFrame(animate);
        render();
        camerarotation(rotationy);
        powerleftandtime(usage,Time.getDelta())
        windowflashing();
        rightflashing();
        leftflashing();
        countusage();
		tabletflip()
        ///////////////// shader
        //meshMaterial.uniforms.mytime.value = clock.getElapsedTime();

        //////////////////////////////////
        if(movingstep==2&&mov==0&&block==0){
            console.log('correct');
            setTimeout(moves,3000);
            mov=1;
        }
		else if(movingstep==3&&ready==1){
			 	
				t += clock.getDelta();
                t %= 30.6;
				keyframe(t);

                if(ghost.mov!=3){
				ghost.ghost.rotation.x = intkey[0];
                ghost.ghost.position.y = intkey[1]-5;
				
				if(ghost.mov==1){
					ghost.ghost.rotation.y = intkey[2]+0.068;
				}
				else if(ghost.mov==2){
					ghost.ghost.rotation.y = intkey[2]*(-1)+0.068;
				}

                ghost.rightHand.rotation.x = intkey[3];
				ghost.rightHand.rotation.z = intkey[4];
				
				ghost.rightHand2.rotation.x = intkey[5];
				ghost.rightHand2.rotation.z = intkey[6];
				
				ghost.leftHand.rotation.x = intkey[7];
				ghost.leftHand.rotation.z = intkey[8];
				
				ghost.leftHand2.rotation.x = intkey[9];
				ghost.leftHand2.rotation.z = intkey[10];
				
				ghost.rightLeg.rotation.x = intkey[11];
				ghost.rightLeg.rotation.z = intkey[12];
				
				ghost.rightLeg2.rotation.x = intkey[13];
				ghost.rightLeg2.rotation.z = intkey[14];
				
				ghost.leftLeg.rotation.x = intkey[15];
                ghost.leftLeg.rotation.z = intkey[16];
				
				ghost.leftLeg2.rotation.x = intkey[17];
				ghost.leftLeg2.rotation.z = intkey[18];
			}
			else if(ghost.mov==3&&ready==1){
				
				t2 += clock.getDelta();
                t2 %= 30.6;
				backkeyframe(t2);
				
				ghost.ghost.backrotation.x = backintkey[0];
                ghost.ghost.backposition.y = backintkey[1];				
				ghost.ghost.backrotation.y = backintkey[2];

                ghost.backrightHand.rotation.x = backintkey[3];
				ghost.backrightHand.rotation.z = backintkey[4];
				
				ghost.backrightHand2.rotation.x = backintkey[5];
				ghost.backrightHand2.rotation.z = backintkey[6];
				
				ghost.backleftHand.rotation.x = backintkey[7];
				ghost.backleftHand.rotation.z = backintkey[8];
				
				ghost.backleftHand2.rotation.x = backintkey[9];
				ghost.backleftHand2.rotation.z = backintkey[10];
				
				ghost.backrightLeg.rotation.x = backintkey[11];
				ghost.backrightLeg.rotation.z = backintkey[12];
				
				ghost.backrightLeg2.rotation.x = backintkey[13];
				ghost.backrightLeg2.rotation.z = backintkey[14];
				
				ghost.backleftLeg.rotation.x = backintkey[15];
                ghost.backleftLeg.rotation.z = backintkey[16];
				
				ghost.backleftLeg2.rotation.x = backintkey[17];
				ghost.backleftLeg2.rotation.z = backintkey[18];
				}
			}
		}
        ///////////////////////////////////////////// ghost moving
        /*
        function start() {
            var test = Math.floor(Math.random()*10000);
            if(ghost.mov==1){
                if(test>0&&test<30){
                    ghost.ghost.position.set(-145,0,-45);
                }
            }
            else if(ghost.mov==2){
                if(test>0&&test<30){
                    ghost.ghost.position.set(145,0,-45);
                }               
            }

        }
        */


        function render() {
            renderer.clear(true);
            renderer.render(scene, camera);
            renderer.render(sceneHUD, cameraHUD);
        }

        
		function keyframe(t) {
            
                var s = ((t - ts) % T) / T;

                 for (var i = 1; i < keys.length; i++) {
					if (keys[i][0] > s) break;
				}

                var ii = i - 1;
                if(i === 6)i = 0;

                var a = (s - keys[ii][0]) / (keys[ii + 1][0] - keys[ii][0]);

                var one = ts+T;
                if(t>one){
                    intkey=[keys[ii][1].bodyRotate = 0.2879,
                            keys[ii][1].bodyHeight =0.001,
                            keys[ii][1].bodyRotateY =1.1191,
                            keys[ii][1].rightHandX =-1.1864,
                            keys[ii][1].rightHandZ=-0.5852,
                            keys[ii][1].rightHand2X =-0.5834,
                            keys[ii][1].rightHand2Z =0.001,
                            keys[ii][1].leftHandX =-1.1864,
                            keys[ii][1].leftHandZ=0.5852,
                            keys[ii][1].leftHand2X =-0.5834,
                            keys[ii][1].leftHand2Z =0.001,
                            keys[ii][1].rightLegX =0.001,
                            keys[ii][1].rightLegZ =0.001,
                            keys[ii][1].rightLeg2X =0.001,
                            keys[ii][1].rightLeg2Z =0.001,
                            keys[ii][1].leftLegX =0.001,
                            keys[ii][1].leftLegZ =0.001,
                            keys[ii][1].leftLeg2X=0.001,
                            keys[ii][1].leftLeg2Z =0.001
                    ];
                }
                else{
                intkey=[ 
                            keys[ii][1].bodyRotate * (1 - a) + keys[ii + 1][1].bodyRotate * a,
                            keys[ii][1].bodyHeight * (1 - a) + keys[ii + 1][1].bodyHeight * a,
                            keys[ii][1].bodyRotateY * (1 - a) + keys[ii + 1][1].bodyRotateY * a,
                            
                            keys[ii][1].rightHandX * (1 - a) + keys[ii + 1][1].rightHandX * a,
                            keys[ii][1].rightHandZ * (1 - a) + keys[ii + 1][1].rightHandZ * a,
                        /////////////////////////////////////////////////////////////////////////////////
                            keys[ii][1].rightHand2X * (1 - a) + keys[ii + 1][1].rightHand2X * a,
                            keys[ii][1].rightHand2Z * (1 - a) + keys[ii + 1][1].rightHand2Z * a,
                        
                            keys[ii][1].leftHandX * (1 - a) + keys[ii + 1][1].leftHandX * a,
                            keys[ii][1].leftHandZ * (1 - a) + keys[ii + 1][1].leftHandZ * a,
                        ////////////////////////////////////////////////////////////////////////////////
                            keys[ii][1].leftHand2X * (1 - a) + keys[ii + 1][1].leftHand2X * a,
                            keys[ii][1].leftHand2Z * (1 - a) + keys[ii + 1][1].leftHand2Z * a,
                    
                            keys[ii][1].rightLegX * (1 - a) + keys[ii + 1][1].rightLegX * a,
                            keys[ii][1].rightLegZ * (1 - a) + keys[ii + 1][1].rightLegZ * a,
                        ////////////////////////////////////////////////////////////////////////////////
                            keys[ii][1].rightLeg2X * (1 - a) + keys[ii + 1][1].rightLeg2X * a,
                            keys[ii][1].rightLeg2Z * (1 - a) + keys[ii + 1][1].rightLeg2Z * a,
                        
                            keys[ii][1].leftLegX * (1 - a) + keys[ii + 1][1].leftLegX * a,
                            keys[ii][1].leftLegZ * (1 - a) + keys[ii + 1][1].leftLegZ * a,
                        ////////////////////////////////////////////////////////////////////////////////
                            keys[ii][1].leftLeg2X * (1 - a) + keys[ii + 1][1].leftLeg2X * a,
                            keys[ii][1].leftLeg2Z * (1 - a) + keys[ii + 1][1].leftLeg2Z * a		
                ];
                }
			
        }

		function backkeyframe(t2) {
            
                var s2 = ((t2 - ts2) % T2) / T2;

                 for (var i2 = 1; i2 < backkeys.length; i2++) {
					if (backkeys[i2][0] > s2) break;
				}

                console.log(i2);

                var ii2 = i2 - 1;
                if(i2 === 6)i2 = 0;

                var a2 = (s2 - backkeys[ii2][0]) / (backkeys[ii2 + 1][0] - backkeys[ii2][0]);

               backintkey=[ 
					    backkeys[ii2][1].backbodyRotate * (1 - a2) + backkeys[ii2 + 1][1].backbodyRotate * a2,
						backkeys[ii2][1].backbodyHeight * (1 - a2) + backkeys[ii2 + 1][1].backbodyHeight * a2,
						backkeys[ii2][1].backbodyRotateY * (1 - a2) + backkeys[ii2 + 1][1].backbodyRotateY * a2,
						
						backkeys[ii2][1].backrightHandX * (1 - a2) + backkeys[ii2 + 1][1].backrightHandX * a2,
						backkeys[ii2][1].backrightHandZ * (1 - a2) + backkeys[ii2 + 1][1].backrightHandZ * a2,
					/////////////////////////////////////////////////////////////////////////////////
						backkeys[ii2][1].backrightHand2X * (1 - a2) + backkeys[ii2 + 1][1].backrightHand2X * a2,
						backkeys[ii2][1].backrightHand2Z * (1 - a2) + backkeys[ii2 + 1][1].backrightHand2Z * a2,
					
						backkeys[ii2][1].backleftHandX * (1 - a2) + backkeys[ii2 + 1][1].backleftHandX * a2,
						backkeys[ii2][1].backleftHandZ * (1 - a2) + backkeys[ii2 + 1][1].backleftHandZ * a2,
					////////////////////////////////////////////////////////////////////////////////
						backkeys[ii2][1].backleftHand2X * (1 - a2) + backkeys[ii2 + 1][1].backleftHand2X * a2,
						backkeys[ii2][1].backleftHand2Z * (1 - a2) + backkeys[ii2 + 1][1].backleftHand2Z * a2,
				   
						backkeys[ii2][1].backrightLegX * (1 - a2) + backkeys[ii2 + 1][1].backrightLegX * a2,
						backkeys[ii2][1].backrightLegZ * (1 - a2) + backkeys[ii2 + 1][1].backrightLegZ * a2,
					////////////////////////////////////////////////////////////////////////////////
						backkeys[ii2][1].backrightLeg2X * (1 - a2) + backkeys[ii2 + 1][1].backrightLeg2X * a2,
						backkeys[ii2][1].backrightLeg2Z * (1 - a2) + backkeys[ii2 + 1][1].backrightLeg2Z * a2,
					
						backkeys[ii2][1].backleftLegX * (1 - a2) + backkeys[ii2 + 1][1].backleftLegX * a2,
						backkeys[ii2][1].backleftLegZ * (1 - a2) + backkeys[ii2 + 1][1].backleftLegZ * a2,
					////////////////////////////////////////////////////////////////////////////////
						backkeys[ii2][1].backleftLeg2X * (1 - a2) + backkeys[ii2 + 1][1].backleftLeg2X * a2,
						backkeys[ii2][1].backleftLeg2Z * (1 - a2) + backkeys[ii2 + 1][1].backleftLeg2Z * a2
						

						
						
               ];
			
			
        }
		

        function loadJSON() {
            return {
                "preset": "Step6",
                "remembered": {
                    "Default": {
                        "0": {
                            "bodyRotate": 0.001,
                            "bodyHeight": 0.001,
                            "rightHandX": 0.001,
							"rightHand2X": 0.001,
                            "rightHandZ": 0.001,
							"rightHand2Z": 0.001,
                            "leftHandX": 0.001,
							"leftHand2X": 0.001,
                            "leftHandZ": 0.001,
							"leftHand2Z": 0.001,
                            "rightLegX": 0.001,
							"rightLeg2X": 0.001,
                            "rightLegZ": 0.001,
							"rightLeg2Z": 0.001,
                            "leftLegX": 0.001,
							"leftLeg2X": 0.001,
                            "leftLegZ": 0.001,
							"leftLeg2Z": 0.001
                        }
                    },
                    "Step0": {
                        "0": {
							  "bodyRotate": 0.001,
                            "bodyHeight": 0.001,
                            "rightHandX": 0.001,
							"rightHand2X": 0.001,
                            "rightHandZ": 0.001,
							"rightHand2Z": 0.001,
                            "leftHandX": 0.001,
							"leftHand2X": 0.001,
                            "leftHandZ": 0.001,
							"leftHand2Z": 0.001,
                            "rightLegX": 0.001,
							"rightLeg2X": 0.001,
                            "rightLegZ": 0.001,
							"rightLeg2Z": 0.001,
                            "leftLegX": 0.001,
							"leftLeg2X": 0.001,
                            "leftLegZ": 0.001,
							"leftLeg2Z": 0.001
                        }
                    },
                    "Step1": {
                        "0": {
                         "bodyRotate": 0.001,
                            "bodyHeight": 0.001,
                            "rightHandX": 0.001,
							"rightHand2X": 0.001,
                            "rightHandZ": 0.001,
							"rightHand2Z": 0.001,
                            "leftHandX": 0.001,
							"leftHand2X": 0.001,
                            "leftHandZ": 0.001,
							"leftHand2Z": 0.001,
                            "rightLegX": 0.001,
							"rightLeg2X": 0.001,
                            "rightLegZ": 0.001,
							"rightLeg2Z": 0.001,
                            "leftLegX": 0.001,
							"leftLeg2X": 0.001,
                            "leftLegZ": 0.001,
							"leftLeg2Z": 0.001
                        }
                    },
                    "Step2": {
                        "0": {
                            "bodyRotate": 0.001,
                            "bodyHeight": 0.001,
                            "rightHandX": 0.001,
							"rightHand2X": 0.001,
                            "rightHandZ": 0.001,
							"rightHand2Z": 0.001,
                            "leftHandX": 0.001,
							"leftHand2X": 0.001,
                            "leftHandZ": 0.001,
							"leftHand2Z": 0.001,
                            "rightLegX": 0.001,
							"rightLeg2X": 0.001,
                            "rightLegZ": 0.001,
							"rightLeg2Z": 0.001,
                            "leftLegX": 0.001,
							"leftLeg2X": 0.001,
                            "leftLegZ": 0.001,
							"leftLeg2Z": 0.001
                        }
                    },
                    "Step3": {
                        "0": {
                             "bodyRotate": 0.001,
                            "bodyHeight": 0.001,
                            "rightHandX": 0.001,
							"rightHand2X": 0.001,
                            "rightHandZ": 0.001,
							"rightHand2Z": 0.001,
                            "leftHandX": 0.001,
							"leftHand2X": 0.001,
                            "leftHandZ": 0.001,
							"leftHand2Z": 0.001,
                            "rightLegX": 0.001,
							"rightLeg2X": 0.001,
                            "rightLegZ": 0.001,
							"rightLeg2Z": 0.001,
                            "leftLegX": 0.001,
							"leftLeg2X": 0.001,
                            "leftLegZ": 0.001,
							"leftLeg2Z": 0.001
                        }
                    },
                    "Step4": {
                        "0": {
                            "bodyRotate": 0.001,
                            "bodyHeight": 0.001,
                            "rightHandX": 0.001,
							"rightHand2X": 0.001,
                            "rightHandZ": 0.001,
							"rightHand2Z": 0.001,
                            "leftHandX": 0.001,
							"leftHand2X": 0.001,
                            "leftHandZ": 0.001,
							"leftHand2Z": 0.001,
                            "rightLegX": 0.001,
							"rightLeg2X": 0.001,
                            "rightLegZ": 0.001,
							"rightLeg2Z": 0.001,
                            "leftLegX": 0.001,
							"leftLeg2X": 0.001,
                            "leftLegZ": 0.001,
							"leftLeg2Z": 0.001
                        }
                    },
                    "Step5": {
                        "0": {
                            "bodyRotate": 0.001,
                            "bodyHeight": 0.001,
                            "rightHandX": 0.001,
							"rightHand2X": 0.001,
                            "rightHandZ": 0.001,
							"rightHand2Z": 0.001,
                            "leftHandX": 0.001,
							"leftHand2X": 0.001,
                            "leftHandZ": 0.001,
							"leftHand2Z": 0.001,
                            "rightLegX": 0.001,
							"rightLeg2X": 0.001,
                            "rightLegZ": 0.001,
							"rightLeg2Z": 0.001,
                            "leftLegX": 0.001,
							"leftLeg2X": 0.001,
                            "leftLegZ": 0.001,
							"leftLeg2Z": 0.001
                        }
                    },
                    "Step6": {
                        "0": {
                            "bodyRotate": 0.001,
                            "bodyHeight": 0.001,
                            "rightHandX": 0.001,
							"rightHand2X": 0.001,
                            "rightHandZ": 0.001,
							"rightHand2Z": 0.001,
                            "leftHandX": 0.001,
							"leftHand2X": 0.001,
                            "leftHandZ": 0.001,
							"leftHand2Z": 0.001,
                            "rightLegX": 0.001,
							"rightLeg2X": 0.001,
                            "rightLegZ": 0.001,
							"rightLeg2Z": 0.001,
                            "leftLegX": 0.001,
							"leftLeg2X": 0.001,
                            "leftLegZ": 0.001,
							"leftLeg2Z": 0.001
                        }
                    }
                },
                "closed": false,
                "folders": {}
            }
        }
			
///////////////////////////////////////////////////////////////////////////////		
		
		function windowflashing(){
            
        if(lightstate3 == 1){
            windowlightsound.play();
            if(Time.elapsedTime % 3 < 1){
            light3.distance = 50;
            }
            else if(Time.elapsedTime % 5 > 1 && Time.elapsedTime % 5 < 1.2){
            light3.distance = 40;
            }
            else if(Time.elapsedTime % 5 > 1.2 && Time.elapsedTime % 5 < 1.3){
            light3.distance = 50;
            }
            else if(Time.elapsedTime % 5 > 1.3 && Time.elapsedTime % 5 < 1.5){
            light3.distance = 35;
            }
            else if(Time.elapsedTime % 5 > 1.5 && Time.elapsedTime % 5 < 2){
            light3.distance = 50;
            }
            else if(Time.elapsedTime % 5 > 2 && Time.elapsedTime % 5 < 2.3){
            light3.distance = 40;
            }
            else if(Time.elapsedTime % 5 > 2.3 && Time.elapsedTime % 5 < 2.5){
            light3.distance = 50;
            }
            else if(Time.elapsedTime % 5 > 2.5 && Time.elapsedTime % 5 < 2.7){
            light3.distance = 40;
            }
            else{
            light3.distance = 50;
            }
        }
        else {
            windowlightsound.pause();
            light3.distance = 1;
        }
        
        }

        function rightflashing(){
        if(lightstate1 == 1){
            //rightlightsound.play();   
            light11.distance = 65;
            
            if(Time.elapsedTime % 3 < 1){
            light1.distance = 65;
            }
            else if(Time.elapsedTime % 5 > 1 && Time.elapsedTime % 5 < 1.2){
            light1.distance = 45;
            light11.distance = 65;
            }
            else if(Time.elapsedTime % 5 > 1.2 && Time.elapsedTime % 5 < 1.3){
            light1.distance = 65;
            light11.distance = 55;
            }
            else if(Time.elapsedTime % 5 > 1.3 && Time.elapsedTime % 5 < 1.5){
            light1.distance = 35;
            light11.distance = 65;
            }
            else if(Time.elapsedTime % 5 > 1.5 && Time.elapsedTime % 5 < 2){
            light1.distance = 65;
            light11.distance = 55;
            }
            else if(Time.elapsedTime % 5 > 2 && Time.elapsedTime % 5 < 2.3){
            light1.distance = 45;
            light11.distance = 65;
            }
            else if(Time.elapsedTime % 5 > 2.3 && Time.elapsedTime % 5 < 2.5){
            light1.distance = 65;
            }
            else if(Time.elapsedTime % 5 > 2.5 && Time.elapsedTime % 5 < 2.7){
            light1.distance = 45;
            }
            else{
            light1.distance = 65;
            }
        }
        else{
        rightlightsound.pause();
        light1.distance = 1;
        light11.distance = 1;
        }
        
        }

        function leftflashing(){
            
        if(lightstate2 == 1){
            //leftlightsound.play();
            light21.distance = 65;
            
            if(Time.elapsedTime % 3 < 1){
            light2.distance = 65;
            }
            else if(Time.elapsedTime % 5 > 1 && Time.elapsedTime % 5 < 1.2){
            light2.distance = 45;
            light21.distance = 65;
            }
            else if(Time.elapsedTime % 5 > 1.2 && Time.elapsedTime % 5 < 1.3){
            light2.distance = 65;
            light21.distance = 55;
            }
            else if(Time.elapsedTime % 5 > 1.3 && Time.elapsedTime % 5 < 1.5){
            light2.distance = 35;
            light21.distance = 65;
            }
            else if(Time.elapsedTime % 5 > 1.5 && Time.elapsedTime % 5 < 2){
            light2.distance = 65;
            light21.distance = 55;
            }
            else if(Time.elapsedTime % 5 > 2 && Time.elapsedTime % 5 < 2.3){
            light2.distance = 45;
            light21.distance = 65;
            }
            else if(Time.elapsedTime % 5 > 2.3 && Time.elapsedTime % 5 < 2.5){
            light2.distance = 65;
            }
            else if(Time.elapsedTime % 5 > 2.5 && Time.elapsedTime % 5 < 2.7){
            light2.distance = 45;
            }
            else{
            light2.distance = 65;
            }
        }
        else{
        leftlightsound.pause();
        light2.distance = 1;
        light21.distance = 1;
        }
        }


        function maketable(l ,x ,z){

        var texture = new THREE.TextureLoader().load( 'https://i.imgur.com/FM8caZz.jpg' );

        // immediately use the texture for material creation
        var texMat = new THREE.MeshPhongMaterial( { map: texture } );


        var material = new THREE.MeshPhongMaterial( {color: 0xffffff, side: THREE.DoubleSide} );

        var geometry = new THREE.BoxGeometry( 10*l, l, 5*l );
        var table = new THREE.Mesh( geometry, texMat );
        scene.add(table);
        table.position.set(x, 5.5*l, z);

        var geometry = new THREE.BoxGeometry( l, 5*l, l );
        //var material = new THREE.MeshNormalMaterial()
        var cube1 = new THREE.Mesh( geometry, material );
        scene.add( cube1 );
        table.add(cube1);
        cube1.position.set(-8*l/2,-3*l,-3*l/2);
        var cube2 = new THREE.Mesh( geometry, material );
        scene.add( cube2 );
        table.add(cube2);
        cube2.position.set(-8*l/2,-3*l,3*l/2);
        var cube3 = new THREE.Mesh( geometry, material );
        scene.add( cube3 );
        table.add(cube3);
        cube3.position.y = 5*l/2;
        cube3.position.set(8*l/2,-3*l,3*l/2);
        var cube4 = new THREE.Mesh( geometry, material );
        scene.add( cube4 );
        table.add(cube4);
        cube4.position.set(8*l/2,-3*l,-3*l/2);
        }

        function makewall(Dsize, wallheight){
            var geometry = new THREE.BoxGeometry(5, wallheight ,100);
            var material = new THREE.MeshPhongMaterial( {color: 0x5c4332, side: THREE.DoubleSide} );
            var rightwall = new THREE.Mesh( geometry, material );
        scene.add( rightwall );
        rightwall.position.set(100,wallheight/2,50);
        var leftwall = new THREE.Mesh( geometry, material );
        scene.add( leftwall );
        leftwall.position.set(-100,wallheight/2,50);
        
        var geometry = new THREE.BoxGeometry(5, wallheight ,100 - Dsize);
        var rightwall2 = new THREE.Mesh( geometry, material );
        scene.add( rightwall2 );
        rightwall2.position.set(100,wallheight/2,-100 +(100 - Dsize)/2);
        var leftwall2 = new THREE.Mesh( geometry, material );
        scene.add( leftwall2 );
        leftwall2.position.set(-100,wallheight/2,-100 +(100 - Dsize)/2);
        
        ///////////////////////////door//////////////////////////

        let loader = new THREE.TextureLoader();
        loader.crossOrigin = '';
        texture = loader.load('https://i.imgur.com/awWOSCI.jpg');
        alpha = loader.load('https://i.imgur.com/awWOSCI.jpg');
        var texMat = new THREE.MeshPhongMaterial({
            map: texture,
            //alphaMap: alpha,
            transparent: true,
            side: THREE.DoubleSide
        });
        
        var geometry = new THREE.BoxGeometry(4.9, wallheight , Dsize);
        rightdoor = new THREE.Mesh( geometry, texMat );
        rightdoor.position.set(100,wallheight/2,-1*Dsize/2);
            scene.add( rightdoor );
        leftdoor = new THREE.Mesh( geometry, texMat );
        leftdoor.position.set(-100,wallheight/2,-1*Dsize/2);
        scene.add( leftdoor );
        
        }
        ///////////////////////////////////////////////////////////////////

        function makewindow(wallheight, windowsize){

            
        let loader = new THREE.TextureLoader();
        loader.crossOrigin = '';
        texture = loader.load('https://i.imgur.com/pzdqvl6.png');
        alpha = loader.load('https://i.imgur.com/awWOSCI.jpg');
        var texMat = new THREE.MeshPhongMaterial({
            map: texture,
            //alphaMap: alpha,
            transparent: true,
            side: THREE.DoubleSide
        });
        var geometry = new THREE.BoxGeometry(windowsize, windowsize ,5);
            windowdoor = new THREE.Mesh( geometry, texMat );
            
        windowdoor.position.set(0,wallheight + windowsize/2,100-0.01)
        scene.add( windowdoor );
        
        
        ///////////////front walls///////////////////

        var geometry = new THREE.BoxGeometry(200, windowsize + 20,5);
            var material = new THREE.MeshPhongMaterial( {color: 0x5c4332, side: THREE.DoubleSide} );
            var walls1 = new THREE.Mesh( geometry, material );
            scene.add( walls1 );
        walls1.position.set(0,wallheight + windowsize/2,-100);

        ///////////////right and left walls///////////////////

        var geometry = new THREE.BoxGeometry(5, windowsize + 20 ,200);
        var walls2 = new THREE.Mesh( geometry, material );
            scene.add( walls2 );
        walls2.position.set(100, wallheight + windowsize/2, 0);
        var walls3 = new THREE.Mesh( geometry, material );
            scene.add( walls3 );
        walls3.position.set(-100, wallheight + windowsize/2, 0);

        ///////////////right and left walls///////////////////

        var geometry = new THREE.BoxGeometry((200-windowsize)/2, windowsize ,5);
        var walls4 = new THREE.Mesh( geometry, material );
            scene.add( walls4 );
        walls4.position.set(windowsize/2+(200-windowsize)/2/2, wallheight + windowsize/2, 100);
        var walls5 = new THREE.Mesh( geometry, material );
            scene.add( walls5 );
        walls5.position.set(-(windowsize/2+(200-windowsize)/2/2), wallheight + windowsize/2, 100);
        
        
        
        var geometry = new THREE.BoxGeometry(2, windowsize ,80);
        loader.crossOrigin = '';
        texture = loader.load('https://i.imgur.com/ZUWRF8R.jpg');
        alpha = loader.load('https://i.imgur.com/awWOSCI.jpg');
        var texMat = new THREE.MeshPhongMaterial({
            map: texture,
            //alphaMap: alpha,
            transparent: true,
            side: THREE.DoubleSide
        });
            var windows1 = new THREE.Mesh( geometry, texMat );
            scene.add( windows1 );
            windows1.position.set(windowsize/2 - 1,wallheight + windowsize/2,100 + 40 - 2.5)
        
        var windows2 = new THREE.Mesh( geometry, texMat );
            scene.add( windows2 );
            windows2.position.set(-windowsize/2 + 1,wallheight + windowsize/2,100 + 40 - 2.5)
        
        var geometry = new THREE.BoxGeometry(windowsize - 4, 2 ,40);
        
        var windows3 = new THREE.Mesh( geometry, texMat );
            scene.add( windows3 );
            windows3.position.set(0 ,wallheight + windowsize/2 + windowsize/2 - 1,100 + 20 - 2.5)
        
        var geometry = new THREE.BoxGeometry(windowsize - 4, 2 ,80);
        
        var windows4 = new THREE.Mesh( geometry, texMat );
            scene.add( windows4 );
            windows4.position.set(0 ,wallheight + windowsize/2 - windowsize/2 + 1,100 + 40 - 2.5)
        
        var geometry = new THREE.BoxGeometry(40, 80 ,2);
        
        var windows5 = new THREE.Mesh( geometry, texMat );
            scene.add( windows5 );
            windows5.position.set(0 ,wallheight + windowsize/2 - windowsize/2 + 40,100 + 80 - 2.5)
        
        
        var geometry = new THREE.BoxGeometry(2, 40 ,40);
        
        var windows6 = new THREE.Mesh( geometry, texMat );
            scene.add( windows6 );
            windows6.position.set(20 - 1 ,wallheight + windowsize/2 - windowsize/2 + 60,100 + 60 - 2.5)
        
        var windows7 = new THREE.Mesh( geometry, texMat );
            scene.add( windows7 );
            windows7.position.set(-20 + 1 ,wallheight + windowsize/2 - windowsize/2 + 60,100 + 60 - 2.5)
        
        var windowlightbox = new THREE.Mesh (new THREE.BoxGeometry (8,3,25), new THREE.MeshPhongMaterial({color:0xffffff}))
        scene.add(windowlightbox);
        windowlightbox.position.set(0 , wallheight + windowsize/2 + windowsize/2 - 3 , 100 + 25/2 + 5)
        }

        function openrightdoor(){
            for(var i = 0 ; i < wallheight ; ){
        rightdoor.position.y += 0.01; 
        i = i + 0.01;
        }
        rdoor = false;
        doorsound.play();
        }

        function closerightdoor(){
            for(var i = 0 ; i < wallheight ; ){
        rightdoor.position.y -= 0.01; 
        i = i + 0.01;
        }
        rdoor = true;
        doorsound2.play();
        }

        function openleftdoor(){
            for(var i = 0 ; i < wallheight ; ){
        leftdoor.position.y += 0.01; 
        i = i + 0.01;
        }
        ldoor = false;
        doorsound.play();
        }

        function closeleftdoor(){
            for(var i = 0 ; i < wallheight ; ){
        leftdoor.position.y -= 0.01; 
        i = i + 0.01;
        }
        ldoor = true;
        doorsound2.play();
        }

        function openwindowdoor(){
            for(var i = 0 ; i < windowsize ; ){
        windowdoor.position.y += 0.01; 
        i = i + 0.01;
        }
        wdoor = false;
        ventsound.pause();
        ventsound.play();
        }

        function closewindowdoor(){
            for(var i = 0 ; i < windowsize ; ){
        windowdoor.position.y -= 0.01; 
        i = i + 0.01;
        }
        wdoor = true;
        ventsound.pause();
        ventsound.play();
        }

        function onDocumentMouseMove(event) {

        event.preventDefault();
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        //mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        if(mouse.x > 0.3 && viewpoint == 1)	rotationy = (mouse.x-0.3)*2;
        else if(mouse.x < -0.3 && viewpoint == 1) rotationy = (mouse.x+0.3)*2;
        else rotationy = 0;
            

        }

        function makebuttoms(wallheight,doorsize){
            /// set door buttom 
        var geometry = new THREE.BoxGeometry(2, 5 ,5);
            var material = new THREE.MeshPhongMaterial( {color: 0xff0000, side: THREE.DoubleSide} );
            var rightdoorbuttom = new THREE.Mesh( geometry, material );
        scene.add(rightdoorbuttom);
        rightdoorbuttom.position.set(97,wallheight / 2 + 10 , (-100 +(100 - doorsize))/2 + doorsize / 2 + 10);
        rightdoorpickables.push(rightdoorbuttom) ;
        var leftdoorbuttom = new THREE.Mesh( geometry, material );
        scene.add(leftdoorbuttom);
        leftdoorbuttom.position.set(-97,wallheight / 2 + 10 , (-100 +(100 - doorsize))/2 + doorsize / 2 + 10);
        leftdoorpickables.push(leftdoorbuttom);
        //// door buttom
        document.addEventListener('mousedown', rightsidedoor, false);
        document.addEventListener('mousedown', leftsidedoor, false);
        
        
        //window door buttom
        var geometry = new THREE.BoxGeometry(5, 5 ,2);
        var windowdoorbuttom = new THREE.Mesh( geometry, material );
        scene.add(windowdoorbuttom);
        windowdoorbuttom.position.set(-25 ,wallheight + 10 , 100 - 5);
        windowdoorpickables.push(windowdoorbuttom) ;
        
        document.addEventListener('mousedown', windowsidedoor, false);
        
        /// set light buttom
        var geometry = new THREE.BoxGeometry(2, 5 ,5);
            var material = new THREE.MeshPhongMaterial( {color: 0xf5f5f5, side: THREE.DoubleSide} );
            var rightlightbuttom = new THREE.Mesh( geometry, material );
        scene.add(rightlightbuttom);
        rightlightbuttom.position.set(97,wallheight / 2 + 3, (-100 +(100 - doorsize))/2 + doorsize / 2 + 10 );
        rightlightpickables.push(rightlightbuttom);
        var leftlightbuttom = new THREE.Mesh( geometry, material );
        scene.add(leftlightbuttom);
        leftlightbuttom.position.set(-97,wallheight / 2 + 3, (-100 +(100 - doorsize))/2 + doorsize / 2 + 10 );
        leftlightpickables.push(leftlightbuttom);
        
        //// light buttom
        document.addEventListener('mousedown', rightsidelight, false);
        document.addEventListener('mousedown', leftsidelight, false);
        
        
        
        //window light buttom
        var geometry = new THREE.BoxGeometry(5, 5 ,2);
        var windowlightbuttom = new THREE.Mesh( geometry, material );
        scene.add(windowlightbuttom);
        windowlightbuttom.position.set(-25 ,wallheight + 2.5 , 100 - 5);
        windowlightpickables.push(windowlightbuttom) ;
        
        document.addEventListener('mousedown', windowsidelight, false);
        
        }

        function rightsidedoor(event) {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        // find intersections
        raycaster.setFromCamera(mouse, camera);
        var intersects = raycaster.intersectObjects(rightdoorpickables, false);
        if (intersects.length > 0) {
            if(rightwallstate == 0){
                openrightdoor();
                rightwallstate = 1;
            }
            else if(rightwallstate == 1){
                closerightdoor();
                rightwallstate = 0;
            }
            }
        }

        function leftsidedoor(event) {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        // find intersections
        raycaster.setFromCamera(mouse, camera);
        var intersects = raycaster.intersectObjects(leftdoorpickables, false);
        if (intersects.length > 0) {
            if(leftwallstate == 0){
            openleftdoor();
            leftwallstate = 1;
            }
            else if(leftwallstate == 1){
            closeleftdoor();
            leftwallstate = 0;
            }
            }
        }

        function windowsidedoor(event){
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        // find intersections
        raycaster.setFromCamera(mouse, camera);
        var intersects = raycaster.intersectObjects(windowdoorpickables, false);
        if (intersects.length > 0) {
            if(windowdoorstate == 0){
            openwindowdoor();
            windowdoorstate = 1;
            }
            else if(windowdoorstate == 1){
            closewindowdoor();
            windowdoorstate = 0;
            }
            }
        }

        function rightsidelight(event) {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        // find intersections
        raycaster.setFromCamera(mouse, camera);
        var intersects = raycaster.intersectObjects(rightlightpickables, false);
        if (intersects.length > 0) {
            //rightlight();
            if(lightstate1 == 0) lightstate1 = 1;
            else if(lightstate1 == 1) lightstate1 = 0;
            }
        }

        function leftsidelight(event) {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        // find intersections
        raycaster.setFromCamera(mouse, camera);
        var intersects = raycaster.intersectObjects(leftlightpickables, false);
        if (intersects.length > 0) {
            //leftlight();
            if(lightstate2 == 0) lightstate2 = 1;
            else if(lightstate2 == 1) lightstate2 = 0;
            }
        }

        function windowsidelight(event) {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        // find intersections
        raycaster.setFromCamera(mouse, camera);
        var intersects = raycaster.intersectObjects(windowlightpickables, false);
        if (intersects.length > 0) {
            //windowlight();
            if(lightstate3 == 0) lightstate3 = 1;
            else if(lightstate3 == 1) lightstate3 = 0;
            }
        }

        function camerarotation(x){
            if(viewpoint != 1) rotationy = 0;
        else if(quickswitch == 0) camera.rotation.y -= x/100;
        else camera.rotation.y += x/100;
        }

        function makehud(){
        var Text2D = THREE_Text.MeshText2D;
        var textAlign = THREE_Text.textAlign;
        
        powertext = new Text2D("Power left:"+Math.floor(power/10)+'%', {
            align: textAlign.center,
            font: '144px Arial',
            fillStyle: '#ffffff',
            antialias: false
        });
        powertext.position.set(-5.5, -5.5, 100);
        powertext.scale.set(0.007, 0.007, 0.007);
        sceneHUD.add(powertext);

        
        usagetext = new Text2D("Usage:", {
            align: textAlign.center,
            font: '144px Arial',
            fillStyle: '#ffffff',
            antialias: false
        });
        usagetext.position.set(-6.2, -6.5, 100);
        usagetext.scale.set(0.007, 0.007, 0.007);
        sceneHUD.add(usagetext);
        
        
            
        
        }



        function powerleftandtime(usage, timepass){
            power = power - usage * timepass;
        powertext.text = 'Power left:'+Math.floor(power/10)+'%'
        var tmptext = 'Usage:'
        var i = 0;
        for(i = 0 ;i < usage ;i++){
            tmptext += 'I';
        }
        for(i = 0 ;i < 8 - usage ;i++){
            tmptext += ' ';
        }
        //console.log(''+usage)
        usagetext.text = tmptext;
        //console.log('usage'+usage)
        //console.log('timepass'+timepass)
        //console.log('power'+power)
        }

        function countusage(){
            if(Math.floor(power/10) > 0) usage = 1;
        else {
        usage = 0;
        return ;
        }
            if(lightstate1 == 1) usage += 1;
        if(lightstate2 == 1) usage += 1;
        if(lightstate3 == 1) usage += 1;
        if(rightwallstate == 0) usage += 1;
        if(leftwallstate == 0) usage += 1;
        if(windowdoorstate == 0) usage += 1;
        
        //console.log(''+usage)
        }

        function makeoutside(){

            var texture = new THREE.TextureLoader().load( 'https://i.imgur.com/FM8caZz.jpg' );

            var texMat = new THREE.MeshPhongMaterial( { map: texture } );


            var geometry = new THREE.PlaneGeometry( 405, 305, 32 );
            var corridor = new THREE.Mesh( geometry, texMat );
            scene.add( corridor );
            corridor.rotation.x = -Math.PI/2;
            corridor.position.y = -0.05;
            corridor.position.z = -50;




            var loader = new THREE.TextureLoader();
            loader.crossOrigin = '';

            texture = loader.load('https://i.imgur.com/FAH1snx.jpg?1');

            texture.repeat.set(6, 6);
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;

            var outwalls1 = new THREE.Mesh(new THREE.BoxGeometry(10, 300 ,300), 
            new THREE.MeshPhongMaterial({map: texture}))
            outwalls1.rotation.x = Math.PI / 2;
            scene.add(outwalls1);
            outwalls1.position.set(-200,50,-50)




            var outwalls2 = new THREE.Mesh(new THREE.BoxGeometry(10, 300 ,300), 
            new THREE.MeshPhongMaterial({map: texture}))
            outwalls2.rotation.x = Math.PI / 2;
            scene.add(outwalls2);
            outwalls2.position.set(200,50,-50)


            var outwalls3 = new THREE.Mesh(new THREE.BoxGeometry(400, 10 ,100), 
            new THREE.MeshPhongMaterial({map: texture}))
            outwalls3.rotation.x = Math.PI / 2;
            scene.add(outwalls3);
            outwalls3.position.set(0,50,-200)

        }


        function onDocumentKeyDown(event) {
  	var keyCode = event.which;
  	// 
  	if (keyCode == 76 && viewpoint == 2) {
  	  if (lightstate1 == 1) lightstate1 = 0;
  	  else if (lightstate1 == 0) lightstate1 = 1;
  	} else if (keyCode == 76 && viewpoint == 0) {
  	  if (lightstate2 == 1) lightstate2 = 0;
  	  else if (lightstate2 == 0) lightstate2 = 1;
  	} else if (keyCode == 66) {
  	  if (switchflag == 0) {
  	    if (viewpoint == 1) switchflag = 1;
  	    else if (viewpoint == 2){
  	    switchflag = 2;
  	    setTimeout(pickupcamera,20);
  	    }
  	    else{
  	    switchflag = 3;
  	    setTimeout(pickupcamera,20);
  	    }
  	    camera.getWorldDirection(test);
  	    camera.position.x = 0;
  	    camera.position.z = 10;
  	    camera.position.y = 40;
  	    camera.lookAt(0, 40, 100);
  	    viewpoint = 1;
  	    quickswitch = 1;
  	    console.log('' + test.z)
  	  } 
  	  else if (switchflag == 1) {
  	    switchflag = 0;
  	    camera.position.x = 0;
  	    camera.position.z = 10;
  	    camera.position.y = 40;
  	    camera.lookAt(test.x, 40, test.z)
  	    if (test.z > 0) quickswitch = 1;
  	    else quickswitch = 0;
  	  } 
  	  else if (switchflag == 2) {
  	    pickupcamera();
  	    setTimeout(switchcondition2,650);
  	  } 
  	  else {
  	    pickupcamera();
  	    setTimeout(switchcondition3,650);
  	  }
	
	  }
	  render();
	}



	function switchcondition2(){
	  camera.position.x = 120;
	  camera.position.z = 100;
	  camera.position.y = 80;
	  camera.lookAt(140, 10, -50);
	  viewpoint = 2;
	  quickswitch = 0;
	  switchflag = 0;
	}
	
	function switchcondition3(){
	  camera.position.x = -120;
	  camera.position.z = 100;
	  camera.position.y = 80;
	  camera.lookAt(-140, 10, -50);
	  viewpoint = 0;
	  quickswitch = 0;
	  switchflag = 0;
	}


	function makecamerabuttom() {
  	var loader = new THREE.TextureLoader();
  	loader.setCrossOrigin('');
  	tex = loader.load('https://i.imgur.com/2RFwjNN.png');
	
	  var camerabuttom = new THREE.Mesh(new THREE.PlaneGeometry(8, 2), new THREE.MeshBasicMaterial({
	    map: tex,
	    alphaTest: 0.5,
	    transparent: true
	  }));
	
	  camerabuttom.position.y = 1e-2;
	
	  sceneHUD.add(camerabuttom);
	  camerabuttom.position.set(0, -7.5, 100)
	  camerapickables.push(camerabuttom);
	
	  document.addEventListener('mousedown', camerachange, false);
	
	}
	
	function camerachange(event) {
	  mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
	  mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
	
	  raycaster.setFromCamera(mouse, cameraHUD);
	  var intersects = raycaster.intersectObjects(camerapickables, false);
	  if (intersects.length > 0) {
		switchflag = 0;
	  	if(pickup == 0){
	    	   pickupcamera();
		   setTimeout(viewpointchange,650);
	        }
	   	else if(pickup == 1 && viewpoint == 0){
	      	   pickupcamera();
		   viewpointchange();
	        }
	  	else viewpointchange();
	  }
	}
	
	
	function maketablet() {
	  var geometry = new THREE.BoxGeometry(20, 2, 10);
	
	  var texture = new THREE.TextureLoader().load('https://i.imgur.com/5x7abFc.png');
	
	  var texMat = new THREE.MeshPhongMaterial({
	    map: texture
	  });
	
	  tablet = new THREE.Mesh(geometry, texMat);
	
	  geometry = new THREE.BoxGeometry(1, 1, 1);
	
	  tabletbody = new THREE.Mesh(geometry, texMat);
	
	  scene.add(tabletbody);
	
	  tabletbody.position.set(0, 0, 10);
	
	  scene.add(tablet);
	
	  tabletbody.add(tablet);
	
	}
	
	function tabletflip() {
	  if (pickup == 1) {
	    if (fliptheta < Math.PI / 2) {
	      tablet.rotation.x += 0.05;
	      fliptheta += 0.05;
	      tablet.position.set(0, 30 + 10 * Math.sin(fliptheta), -10 + -10 * Math.cos(fliptheta));
	    }
	  }
	  if (pickup == 0) {
	    if (fliptheta > 0) {
	      tablet.rotation.x -= 0.05;
	      fliptheta -= 0.05;
	      tablet.position.set(0, 30 + 10 * Math.sin(fliptheta), -10 + -10 * Math.cos(fliptheta));
	    }
	    else tablet.position.set(1000,0,0)
	  }
	
	}
	
	
	function pickupcamera(){
		
	  if (pickup == 0) {
	    camera.getWorldDirection(test);
	    if (test.z < 0) tabletbody.rotation.y = Math.acos(test.x) - 1.57;
	    else if (test.z > 0) tabletbody.rotation.y = -Math.acos(test.x) - 1.57;
	
	    pickup = 1;
	  } 
	  else{
	  	camera.getWorldDirection(test);
	  	if (test.z < 0) tabletbody.rotation.y = Math.acos(test.x) - 1.57;
	  	else if (test.z > 0) tabletbody.rotation.y = -Math.acos(test.x) - 1.57;
	  	pickup = 0;
	  }
	  
	
	}
	
	function viewpointchange(){
	if (viewpoint == 0) {
	      camera.position.x = 0;
	      camera.position.z = 10;
	      camera.position.y = 40;
	      camera.lookAt(0, 40, -100);
	      viewpoint = 1;
	      quickswitch = 0;
	} 
	else if (viewpoint == 1) {
	    camera.position.x = 120;
	    camera.position.z = 100;
	    camera.position.y = 80;
      	camera.lookAt(140, 10, -50);
	    viewpoint = 2;
         quickswitch = 0;
        }
 	else if (viewpoint == 2) {
          camera.position.x = -120;
          camera.position.z = 100;
      	  camera.position.y = 80;
      	  camera.lookAt(-140, 10, -50);
      	  viewpoint = 0;
      	  quickswitch = 0;
    	}

}
    </script>